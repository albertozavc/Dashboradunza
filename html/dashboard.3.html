<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DASHBOARD ACCESSONE </title>
  <meta name="description" content="Admin, Dashboard, Bootstrap, Bootstrap 4, Angular, AngularJS" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-barstyle" content="black-translucent">
  <link rel="apple-touch-icon" href="../assets/images/logo.png">
  <meta name="apple-mobile-web-app-title" content="Flatkit">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" sizes="196x196" href="../assets/images/logo.png">
  <link rel="stylesheet" href="../assets/animate.css/animate.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/glyphicons/glyphicons.css" type="text/css" />
  <link rel="stylesheet" href="../assets/font-awesome/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/material-design-icons/material-design-icons.css" type="text/css" />
  <link rel="stylesheet" href="../assets/bootstrap/dist/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/styles/app.css" type="text/css" />
  <link rel="stylesheet" href="../assets/styles/font.css" type="text/css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 800px; }
  </style>
</head>
<body>
  <div class="app" id="app">
<div id="aside" class="app-aside modal fade folded md show-text nav-dropdown">
  <div class="left navside black dk" layout="column">
    <div class="navbar no-radius">
      <a class="navbar-brand">
        <div ui-include="'../assets/images/logo.svg'"></div>
        <img src="../assets/images/logo.png" alt="." class="hide">
        <span class="hidden-folded inline">ACCESSONE</span>
      </a>
    </div>
    <div flex class="hide-scroll">
      <nav class="scroll nav-active-primary">
        <ul class="nav" ui-nav>
          <li class="nav-header hidden-folded">
            <small class="text-muted">Opciones</small>
          </li>       
          <li>
            <a href="dashboard.3.html">
              <span class="nav-icon">
                <i class="material-icons">&#xe3fc;</i>
              </span>
              <span class="nav-text">Principal</span>
            </a>
          </li>
          <li>
            <a href="historial.html">
              <span class="nav-icon">
                <i class="material-icons">&#xe5c3;</i>
              </span>
              <span class="nav-text">Offline</span>
            </a>
          </li>
          <li>

            
            <a href="contact.html">
              <span class="nav-icon">
                <i class="material-icons">&#xe8f0;</i>
              </span>
              <span class="nav-text">Directorio</span>
            </a>
          </li>
          <li>
            <a href="calendar.html">
              <span class="nav-icon">
                <i class="material-icons">&#xe8d2;</i>
              </span>
              <span class="nav-text">Calendario</span>
            </a>
          </li>
          <li class="nav-header hidden-folded">
            <small class="text-muted">Componentes</small>
          </li>
        </ul>
      </nav>
    </div>
    <div flex-no-shrink>
      <div ui-include="'../views/blocks/aside.top.1.html'"></div>
    </div>
  </div>
</div>
    <div id="content" class="app-content box-shadow-z3" role="main">
    <div class="app-header white box-shadow">
        <div class="navbar navbar-toggleable-sm flex-row align-items-center">
            <a data-toggle="modal" data-target="#aside" class="hidden-lg-up mr-3">
              <i class="material-icons">&#xe5d2;</i>
            </a>
            <div class="mb-0 h5 no-wrap" ng-bind="$state.current.data.title" id="pageTitle"></div>
            <div class="collapse navbar-collapse" id="collapse">
              <ul class="nav navbar-nav mr-auto">
                <li class="nav-item dropdown">
                  <a class="nav-link" href data-toggle="dropdown">
                    <i class="fa fa-fw fa-plus text-muted"></i>
                    <span>Parking M茅xico</span>
                  </a>
                  <div ui-include="'../views/blocks/dropdown.new.html'"></div>
                </li>
              </ul>      
              <div ui-include="'../views/blocks/navbar.form.html'"></div>
            </div>
            <ul class="nav navbar-nav ml-auto flex-row">
              <li class="nav-item dropdown pos-stc-xs">
                <a class="nav-link mr-2" href data-toggle="dropdown">
                  <i class="material-icons">&#xe7f5;</i>
                  <span class="label label-sm up warn">3</span>
                </a>
                <div ui-include="'../views/blocks/dropdown.notification.html'"></div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link p-0 clear" href="#" data-toggle="dropdown">
                  <span class="avatar w-32">
                    <img src="../assets/images/a0.jpg" alt="...">
                    <i class="on b-white bottom"></i>
                  </span>
                </a>
                <div ui-include="'../views/blocks/dropdown.user.html'"></div>
              </li>
              <li class="nav-item hidden-md-up">
                <a class="nav-link pl-2" data-toggle="collapse" data-target="#collapse">
                  <i class="material-icons">&#xe5d4;</i>
                </a>
              </li>
            </ul>
        </div>
    </div>
    <!-- / Pie de pagina -->
    <div class="app-footer">
      <div class="p-2 text-xs">
        <div class="pull-right text-muted py-1">
          &copy; Copyright <strong>AccessOne PARKINGMEXICO</strong> <span class="hidden-xs-down">- v1.0</span>
          <a ui-scroll-to="content"><i class="fa fa-long-arrow-up p-x-sm"></i></a>
        </div>
        <div class="nav">
          <a class="nav-link" href="https://www.accessone.com.mx/contacto.html">Acerca de</a>
          <a class="nav-link" href="https://www.accessone.com.mx">Conocer</a>
        </div>
      </div>
    </div>
    <div ui-view class="app-body" id="view">
    <!-- TEXTO SUPERIOR PAGINA LEVEL 2-->
<div class="dker">
  <div class="tab-content tab-alt">
    <div class="tab-pane in active" id="world">
      <div class="padding">
        <div class="row-col">
          <div class="col-xs-4 v-m">
            <h1 id="total-count" class="_800 l-s-n-4x inline m-r-sm">0</h1>
            <span class="inline l-h-1x">
              DISPOSITIVOS <br>
              <small class="text-muted">Totales en M茅xico</small>
            </span>
          </div>
          <div class="col-xs-4 v-m">
            <h1 id="online-count" class="_800 l-s-n-4x inline m-r-sm text-primary">0</h1>
            <span class="inline l-h-1x">
              En L铆nea  <br>
              <small class="text-muted">Totales en M茅xico</small>
            </span>
          </div>
          <div class="col-xs-4 v-m">
            <h1 id="offline-count" class="_800 l-s-n-4x text-white text-shadow inline m-r-sm">0</h1>
            <span class="inline l-h-1x">
              Fuera de L铆nea  <br>
              <small class="text-muted">Totales en M茅xico</small>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


    <div flex-no-shrink>
      <div ui-include="'../views/blocks/aside.top.1.html'"></div>
    </div>
  </div>
</div>
  <div id="map"></div>
<div class="row-col">
    <div class="col-xs-3 v-m nav-active-primary">
      <div class="p-a">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link p-x-sm active white" href data-toggle="tab" data-target="#world">
              <span class="h5 _700 l-s-n-2x">ACCESS</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link p-x-sm white" href data-toggle="tab" data-target="#usa">
              <span class="h5 _700 l-s-n-2x">ONE</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="col-xs-6 v-m text-center text-sm text-muted p-a">DashBoard de equipos de estacionamiento actualizado a Marzo de 2025</div>
    <div class="col-xs-3 v-m text-right">
      <span ui-jp="sparkline" ui-refresh="app.setting.color" ui-options="[70,30], {type:'pie', height:22, sliceColors:['#0cc2aa','transparent']}" class="sparkline inline m-r"></span>
      <span ui-jp="sparkline" ui-refresh="app.setting.color" ui-options="[30,70], {type:'pie', height:22, sliceColors:['#0cc2aa','transparent']}" class="sparkline inline m-r"></span>
    </div>
  </div>
</div>
  <!-- temas map -->
  <div id="switcher">
    <div class="switcher box-color dark-white text-color" id="sw-theme">
      <a href ui-toggle-class="active" target="#sw-theme" class="box-color dark-white text-color sw-btn">
        <i class="fa fa-gear"></i>
      </a>
      <div class="box-header">
        <h2>Temas del mapa</h2>
      </div>
      <div class="box-divider"></div>
      <div class="box-body">
        <p class="hidden-md-down">
          <label class="md-check m-y-xs"  data-target="folded">
            <input type="checkbox">
            <i class="green"></i>
            <span class="hidden-folded">Ocultar Opciones</span>
          </label>
          <label class="md-check m-y-xs" data-target="boxed">
            <input type="checkbox">
            <i class="green"></i>
            <span class="hidden-folded">Reducir Tama帽o</span>
          </label>
          
        </p>
        <p>Color De Fondo:</p>
        <div data-target="bg" class="row no-gutter text-u-c text-center _600 clearfix">
          <label class="p-a col-sm-6 light pointer m-0">
            <input type="radio" name="theme" value="" hidden>
            Claro
          </label>
          <label class="p-a col-sm-6 grey pointer m-0">
            <input type="radio" name="theme" value="grey" hidden>
            Gris
          </label>
          <label class="p-a col-sm-6 dark pointer m-0">
            <input type="radio" name="theme" value="dark" hidden>
            Oscuro
          </label>
          <label class="p-a col-sm-6 black pointer m-0">
            <input type="radio" name="theme" value="black" hidden>
            Negro
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Inicializar el mapa
const map = L.map('map').setView([19.7027, -101.1827], 6);

// Agregar capa de mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '漏 OpenStreetMap contributors'
}).addTo(map);

// Objeto para almacenar los marcadores
const markers = {};

// Lista de dispositivos monitoreados
const dispositivos = [
    "dispositivo_123", "ServidorAeroColima", "ServidorTepeyac", "ServidorMoroleon",
    "ServidorTacubaya", "ServidorSatelite", "ServidorAzcapotzalco", "ServidorAeropuerto",
    "ServidorCarrizal", "ServidorHoracio", "ServidorSanManuel", "ServidorPeriferico",
    "ServidorSamsOaxaca", "ServidorFerrocarril", "ServidorBuenavista", "ServidorMarianoEscobedo",
    "ServidorLaRaza", "ServidorZitacuaro", "ServidorTlalpan", "ServidorSuperamaVillaHermosa",
    "ServidorAdagio", "ServidorComboCuautitlan", "ServidorDorada1", "ServidorSamsCuautitlan1DeMayo",
    "ServidorComitan", "ServidorKomplex", "ServidorParoli", "ServidorTlaxcala", "ServidorPirules",
    "ServidorForo4", "ServidorTijuana", "ServidorViaSanAngel", "ServidorPlazaAkia", "ServidorLilas",
    "ServidorAeroCDObregon"
];

// Fijar el total de dispositivos seg煤n la cantidad en la lista
const totalDispositivos = dispositivos.length;
document.getElementById("total-count").textContent = totalDispositivos;

// Funci贸n para obtener el estado del dispositivo desde el servidor
async function obtenerEstadoDispositivo(deviceId) {
    try {
        const response = await fetch(`https://mi-servidor-heartbeat-1a3a85a58124.herokuapp.com/api/status/${deviceId}`);
        if (!response.ok) throw new Error("Dispositivo no encontrado");

        const data = await response.json();
        console.log(` Dispositivo ${deviceId}:`, data);

        actualizarMarcador(deviceId, data.latLng.lat, data.latLng.lng, data.status);
    } catch (error) {
        console.error(`Error al obtener estado de ${deviceId}:`, error);
    }
}

// Funci贸n para mostrar una notificaci贸n emergente
// Funci贸n para mostrar una notificaci贸n emergente con el nombre del dispositivo
function mostrarNotificacion(deviceId) {
    Swal.fire({
        title: "锔 Dispositivo fuera de l铆nea",
        text: `El dispositivo "${deviceId}" se ha desconectado.`,
        icon: "warning",
        confirmButtonText: "Entendido",
        timer: 20000,
        timerProgressBar: true
    });
}



// Modificaci贸n en la funci贸n actualizarMarcador para detectar cambios de estado
function actualizarMarcador(deviceId, lat, lng, status) {
    const nuevoColor = status === "online" ? "green" : "red";

    if (markers[deviceId]) {
        const colorAnterior = markers[deviceId].options.fillColor;

        // Verificar si el dispositivo cambi贸 de online a offline
        if (colorAnterior === "green" && nuevoColor === "red") {
    mostrarNotificacion(deviceId);  // Llamar la notificaci贸n cuando cambia a offline
}

        // Si el popup est谩 abierto, lo cerramos antes de actualizar
        if (markers[deviceId].isPopupOpen()) {
            markers[deviceId].closePopup();
        }

        // Actualizar posici贸n y color
        markers[deviceId].setLatLng([lat, lng]);
        markers[deviceId].setStyle({
            fillColor: nuevoColor
        });

        // Actualizar contenido del popup sin necesidad de re-binderlo
        markers[deviceId].setPopupContent(`Dispositivo: ${deviceId}<br>Estado: ${status}`);
    } else {
        // Crear un nuevo marcador si no existe
        markers[deviceId] = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: nuevoColor,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);

        // Asignar popup con la informaci贸n actualizada
        markers[deviceId].bindPopup(`Dispositivo: ${deviceId}<br>Estado: ${status}`);
    }

    // Actualizar contadores
    actualizarContadores();
}

// Pedir permiso para notificaciones al cargar la p谩gina
document.addEventListener("DOMContentLoaded", () => {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});


// Funci贸n para actualizar los contadores de dispositivos en l铆nea y fuera de l铆nea
// Funci贸n para actualizar los contadores de dispositivos en l铆nea y fuera de l铆nea
function actualizarContadores() {
    const online = Object.values(markers).filter(m => m.options.fillColor === "green").length;
    const offline = totalDispositivos - online; // Total fijo - en l铆nea

    document.getElementById("online-count").textContent = online;
    document.getElementById("offline-count").textContent = offline;

    // Obtener la lista de dispositivos offline
    const dispositivosOffline = dispositivos.filter(deviceId => {
        const marker = markers[deviceId];
        return marker && marker.options.fillColor === "red";
    });

    // Guardar la lista de dispositivos offline en localStorage
    localStorage.setItem('dispositivosOffline', JSON.stringify(dispositivosOffline));
}

// Intervalo para actualizar el estado de los dispositivos cada 5 segundos
setInterval(() => {
    dispositivos.forEach(obtenerEstadoDispositivo);
}, 5000);

</script>

  </script>
  <script src="../libs/jquery/jquery/dist/jquery.js"></script>
  <script src="../libs/jquery/tether/dist/js/tether.min.js"></script>
  <script src="../libs/jquery/bootstrap/dist/js/bootstrap.js"></script>
  <script src="../libs/jquery/underscore/underscore-min.js"></script>
  <script src="../libs/jquery/jQuery-Storage-API/jquery.storageapi.min.js"></script>
  <script src="../libs/jquery/PACE/pace.min.js"></script>
  <script src="scripts/config.lazyload.js"></script>
  <script src="scripts/palette.js"></script>
  <script src="scripts/ui-load.js"></script>
  <script src="scripts/ui-jp.js"></script>
  <script src="scripts/ui-include.js"></script>
  <script src="scripts/ui-device.js"></script>
  <script src="scripts/ui-form.js"></script>
  <script src="scripts/ui-nav.js"></script>
  <script src="scripts/ui-screenfull.js"></script>
  <script src="scripts/ui-scroll-to.js"></script>
  <script src="scripts/ui-toggle-class.js"></script>
  <script src="scripts/app.js"></script>
  <script src="../libs/jquery/jquery-pjax/jquery.pjax.js"></script>
  <script src="scripts/ajax.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
