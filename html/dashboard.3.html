<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DASHBOARD ACCESSONE </title>
  <meta name="description" content="Admin, Dashboard, Bootstrap, Bootstrap 4, Angular, AngularJS" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-barstyle" content="black-translucent">
  <link rel="apple-touch-icon" href="../assets/images/logo.png">
  <meta name="apple-mobile-web-app-title" content="Flatkit">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" sizes="196x196" href="../assets/images/logo.png">
  <link rel="stylesheet" href="../assets/animate.css/animate.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/glyphicons/glyphicons.css" type="text/css" />
  <link rel="stylesheet" href="../assets/font-awesome/css/font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/material-design-icons/material-design-icons.css" type="text/css" />
  <link rel="stylesheet" href="../assets/bootstrap/dist/css/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../assets/styles/app.css" type="text/css" />
  <link rel="stylesheet" href="../assets/styles/font.css" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 870px; }
  </style>
</head>
<body>
  <div class="app" id="app">
<div id="aside" class="app-aside modal fade folded md show-text nav-dropdown">
  <div class="left navside black dk" layout="column">
    <div class="navbar no-radius">
      <a class="navbar-brand">
        <div ui-include="'../assets/images/logo.svg'"></div>
        <img src="../assets/images/logo.png" alt="." class="hide">
        <span class="hidden-folded inline">ACCESSONE</span>
      </a>
    </div>
    <div flex class="hide-scroll">
      <nav class="scroll nav-active-primary">
        <ul class="nav" ui-nav>
          <li class="nav-header hidden-folded">
            <small class="text-muted">Opciones</small>
          </li>       
          <li>
            <a href="dashboard.3.html">
              <span class="nav-icon">
                <i class="material-icons">home</i>
              </span>
              <span class="nav-text">Principal</span>
            </a>
          </li>
          <li>
            <a href="historial.html">
              <span class="nav-icon">
                <i class="material-icons">desktop_access_disabled</i>
              </span>
              <span class="nav-text">Offline</span>
            </a>
          </li>
          <li>

            
            <a href="contact.html">
              <span class="nav-icon">
                <i class="material-icons">contacts</i>
              </span>
              <span class="nav-text">Directorio</span>
            </a>
          </li>
          <li>
            <a href="calendar.html">
              <span class="nav-icon">
                <i class="material-icons">calendar_month</i>
              </span>
              <span class="nav-text">Calendario</span>
            </a>
          </li>
          <li class="nav-header hidden-folded">
            <small class="text-muted">Componentes</small>
          </li>
        </ul>
      </nav>
    </div>
    <div flex-no-shrink>
      <div ui-include="'../views/blocks/aside.top.1.html'"></div>
    </div>
  </div>
</div>
    <div id="content" class="app-content box-shadow-z3" role="main">
    <div class="app-header white box-shadow">
        <div class="navbar navbar-toggleable-sm flex-row align-items-center">
            <a data-toggle="modal" data-target="#aside" class="hidden-lg-up mr-3">
              <i class="material-icons">&#xe5d2;</i>
            </a>
            <div class="mb-0 h5 no-wrap" ng-bind="$state.current.data.title" id="pageTitle"></div>
            <div class="collapse navbar-collapse" id="collapse">
              <ul class="nav navbar-nav mr-auto">
                <li class="nav-item dropdown">
                  <a class="nav-link" href data-toggle="dropdown">
                    <i class="material-icons">directions_car</i>
                  <span>Parking México</span>
                  </a>
                  <div ui-include="'../views/blocks/dropdown.new.html'"></div>
                </li>
              </ul>      
              <div ui-include="'../views/blocks/navbar.form.html'"></div>
            </div>
            <ul class="nav navbar-nav ml-auto flex-row">
              <li class="nav-item dropdown pos-stc-xs">
                <div ui-include="'../views/blocks/dropdown.notification.html'"></div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link p-0 clear" href="#" data-toggle="dropdown">
                  <span class="avatar w-32">
                    <img src="../assets/images/a0.jpg" alt="...">
                    <i class="on b-white bottom"></i>
                  </span>
                </a>
                <div ui-include="'../views/blocks/dropdown.user.html'"></div>
              </li>
              <li class="nav-item hidden-md-up">
                <a class="nav-link pl-2" data-toggle="collapse" data-target="#collapse">
                  <i class="material-icons">&#xe5d4;</i>
                </a>
              </li>
            </ul>
        </div>
    </div>
    <!-- / Pie de pagina -->
    <div class="app-footer">
      <div class="p-2 text-xs">
        <div class="pull-right text-muted py-1">
          &copy; Copyright <strong>AccessOne PARKINGMEXICO</strong> <span class="hidden-xs-down">- v2.1</span>
          <a ui-scroll-to="content"><i class="fa fa-long-arrow-up p-x-sm"></i></a>
        </div>
        <div class="nav">
          <a class="nav-link" href="https://www.accessone.com.mx/contacto.html">Acerca de</a>
          <a class="nav-link" href="https://www.accessone.com.mx">Conocer</a>
        </div>
      </div>
    </div>
    <div ui-view class="app-body" id="view">
    <!-- TEXTO SUPERIOR PAGINA LEVEL 2-->
<div class="dker">
  <div class="tab-content tab-alt">
    <div class="tab-pane in active" id="world">
      <div class="padding">
        <div class="row-col">
          <div class="col-xs-4 v-m">
            <h1 id="total-count" class="_800 l-s-n-4x inline m-r-sm">0</h1>
            <span class="inline l-h-1x">
              DISPOSITIVOS <br>
              <small class="text-muted">Totales en México</small>
            </span>
          </div>
          <div class="col-xs-4 v-m">
            <h1 id="online-count" class="_800 l-s-n-4x inline m-r-sm text-primary">0</h1>
            <span class="inline l-h-1x">
              En Línea  <br>
              <small class="text-muted">Totales en México</small>
            </span>
          </div>
          <div class="col-xs-4 v-m">
            <h1 id="offline-count" class="_800 l-s-n-4x text-white text-shadow inline m-r-sm">0</h1>
            <span class="inline l-h-1x">
              Fuera de Línea  <br>
              <small class="text-muted">Totales en México</small>
            </span>
          </div>
        </div>
      </div>
    
  



    <div flex-no-shrink>
      <div ui-include="'../views/blocks/aside.top.1.html'"></div>
    </div>
  </div>
</div>
  <div id="map"></div>
<div class="row-col">
    <div class="col-xs-3 v-m nav-active-primary">
      <div class="p-a">
        <ul class="nav">
        </ul>
      </div>
    </div>
    <div class="col-xs-6 v-m text-center text-sm text-muted p-a">DashBoard de equipos de estacionamiento actualizado a Marzo de 2025</div>
    <div class="col-xs-3 v-m text-right">
      <span ui-jp="sparkline" ui-refresh="app.setting.color" ui-options="[70,30], {type:'pie', height:22, sliceColors:['#0cc2aa','transparent']}" class="sparkline inline m-r"></span>
      <span ui-jp="sparkline" ui-refresh="app.setting.color" ui-options="[30,70], {type:'pie', height:22, sliceColors:['#0cc2aa','transparent']}" class="sparkline inline m-r"></span>
    </div>
  </div>
</div>
  <!-- temas map -->
  <div id="switcher">
    <div class="switcher box-color dark-white text-color" id="sw-theme">
      <a href ui-toggle-class="active" target="#sw-theme" class="box-color dark-white text-color sw-btn">
        <i class="material-icons">settings</i>
      </a>
      <div class="box-header">
        <h2>Temas del mapa</h2>
      </div>
      <div class="box-divider"></div>
      <div class="box-body">
        <p class="hidden-md-down">
          <label class="md-check m-y-xs"  data-target="folded">
            <input type="checkbox">
            <i class="green"></i>
            <span class="hidden-folded">Ocultar Opciones</span>
          </label>
          <label class="md-check m-y-xs" data-target="boxed">
            <input type="checkbox">
            <i class="green"></i>
            <span class="hidden-folded">Reducir Tamaño</span>
          </label>
          
        </p>
        <p>Color De Fondo:</p>
        <div data-target="bg" class="row no-gutter text-u-c text-center _600 clearfix">
          <label class="p-a col-sm-6 light pointer m-0">
            <input type="radio" name="theme" value="" hidden>
            Claro
          </label>
          <label class="p-a col-sm-6 grey pointer m-0">
            <input type="radio" name="theme" value="grey" hidden>
            Gris
          </label>
          <label class="p-a col-sm-6 dark pointer m-0">
            <input type="radio" name="theme" value="dark" hidden>
            Oscuro
          </label>
          <label class="p-a col-sm-6 black pointer m-0">
            <input type="radio" name="theme" value="black" hidden>
            Negro
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Inicializar el mapa
const map = L.map('map').setView([19.7027, -101.1827], 6);

// Agregar capa de mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Objeto para almacenar los marcadores
const markers = {};

// Lista de dispositivos monitoreados
const dispositivos = [
    "ServidorAeroColima", "ServidorTepeyac", "ServidorMoroleon",
    "ServidorTacubaya", "ServidorSatelite", "ServidorAzcapotzalco", "ServidorAeropuerto",
    "ServidorCarrizal", "ServidorHoracio", "ServidorSanManuel", "ServidorPeriferico",
    "ServidorSamsOaxaca", "ServidorFerrocarril", "ServidorBuenavista", "ServidorMarianoEscobedo",
    "ServidorLaRaza", "ServidorZitacuaro", "ServidorTlalpan", "ServidorSuperamaVillaHermosa",
    "ServidorComboCuautitlan", "ServidorSamsCuautitlan1DeMayo",
    "ServidorCinepolisLeon", "ServidorAlamos",
    "ServidorAeroCDObregon", "ServidorComitan", "InterfonE1", "Entrada1", "InterfonS1", "Salida1", "InterfonC1", "Cajero1",
    "InterfonEntradaCDObregon", "EntradaCDObregon", "InterfonSalidaCDObregon", "SalidaCDObregon", "InterfonCajeroCDObregon", "CajeroCDObregon",
    "InterfonEntradaTacubaya", "EntradaTacubaya", "InterfonSalidaTacubaya", "SalidaTacubaya",
    "InterfonEntrada1Satelite", "Entrada1Satelite", "PensionesE1Satelite", "InterfonEntrada2", "Entrada2Satelite", "PensionesE2Satelite", "InterfonEntrada3", "Entrada3Satelite", "PensionesE3Satelite", "InterfonEntrada4", "Entrada4Satelite", "PensionesE4Satelite", "InterfonSalida1Satelite", "Salida1Satelite", "PensionesS1Satelite", "InterfonSalida2", "Salida2Satelite", "PensionesS2Satelite", "InterfonSalida3", "Salida3Satelite", "PensionesS3Satelite", "InterfonSalida4", "Salida4Satelite", "PensionesS4Satelite", "CajeroWalmart1Satelite", "InterfonCajeroWalmart1Satelite", "CajeroWalmart2Satelite", "InterfonCajeroWalmart2Satelite", "CajeroVipsSatelite", "InterfonCajeroVipsSatelite", "CajeroSuburbiaSatelite", "InterfonCajeroSuburbiaSatelite",
    "InterfonEntradaHoracio", "EntradaHoracio", "EntradaPensionesHoracio", "InterfonSalidaHoracio", "SalidaHoracio", "SalidaPensionesHoracio",
    "ServidorSanPedrito", "InterfonEntrada1SanPedrito", "Entrada1SanPedrito", "InterfonEntrada2SanPedrito", "Entrada2SanPedrito", "InterfonSalida1SanPedrito", "Salida1SanPedrito", "InterfonSalida2SanPedrito", "Salida2SanPedrito", "InterfonCajeroSanPedrito", "CajeroSanPedrito",
    "InterfonEntrada1Periferico", "Entrada1Periferico", "InterfonEntrada2Periferico", "Entrada2Periferico", "InterfonEntrada3Periferico", "Entrada3Periferico", "InterfonSalida1Periferico", "Salida1Periferico", "InterfonSalida2Periferico", "Salida2Periferico", "Cajero1Periferico", "InterfonCajero1Periferico", "Cajero2Periferico", "InterfonCajero2Periferico",
    "InterfonEntrada1SamsOaxaca", "Entrada1SamsOaxaca", "InterfonEntrada2SamsOaxaca", "Entrada2SamsOaxaca", "InterfonEntrada3SamsOaxaca", "Entrada3SamsOaxaca", "InterfonSalida1SamsOaxaca", "Salida1SamsOaxaca", "InterfonSalida2SamsOaxaca", "Salida2SamsOaxaca", "InterfonSalida3SamsOaxaca", "Salida3SamsOaxaca", "Cajero1SamsOaxaca", "InterfonCajero1SamsOaxaca", "Cajero2SamsOaxaca", "InterfonCajero2SamsOaxaca",
    "InterfonEntrada1Tlalpan", "Entrada1Tlalpan", "InterfonEntrada2Tlalpan", "Entrada2Tlalpan", "InterfonEntrada3Tlalpan", "Entrada3Tlalpan", "InterfonSalida1Tlalpan", "Salida1Tlalpan", "InterfonSalida2Tlalpan", "Salida2Tlalpan", "InterfonSalida3Tlalpan", "Salida3Tlalpan", "Cajero1Tlalpan", "InterfonCajero1Tlalpan", "Cajero2Tlalpan", "InterfonCajero2Tlalpan", "Cajero3Tlalpan", "InterfonCajero3Tlalpan",
    "InterfonEntrada1Ferrocarril", "Entrada1Ferrocarril", "InterfonEntrada2Ferrocarril", "Entrada2Ferrocarril", "InterfonEntrada3Ferrocarril", "Entrada3Ferrocarril", "InterfonSalida1Ferrocarril", "Salida1Ferrocarril", "InterfonSalida2Ferrocarril", "Salida2Ferrocarril", "Cajero1Ferrocarril", "InterfonCajero1Ferrocarril"
];

// Fijar el total de dispositivos según la cantidad en la lista
const totalDispositivos = dispositivos.length;
document.getElementById("total-count").textContent = totalDispositivos;

// Estado previo de cada dispositivo
const estadoAnterior = {};

// Función para obtener el estado del dispositivo desde el servidor
async function obtenerEstadoDispositivo(deviceId) {
    try {
        const response = await fetch(`https://mi-servidor-heartbeat-1a3a85a58124.herokuapp.com/api/status/${deviceId}`);
        if (!response.ok) throw new Error("Dispositivo no encontrado");

        const data = await response.json();
        console.log(`📡 Dispositivo ${deviceId}:`, data);

        const nuevoEstado = data.status; // "online" o "offline"
        const lat = data.latLng.lat;
        const lng = data.latLng.lng;

        // Si el estado cambia, mostramos notificación
        if (estadoAnterior[deviceId] !== undefined && estadoAnterior[deviceId] !== nuevoEstado) {
            if (nuevoEstado === "offline") {
                mostrarNotificacionOffline(deviceId);
            } else {
                mostrarNotificacionOnline(deviceId);
            }
        }

        // Guardamos el nuevo estado
        estadoAnterior[deviceId] = nuevoEstado;

        // Actualizar el marcador en el mapa
        actualizarMarcador(deviceId, lat, lng, nuevoEstado);

        // Actualizar contadores en tiempo real
        actualizarContadores();

    } catch (error) {
        console.error(`Error al obtener estado de ${deviceId}:`, error);
    }
}

// Notificación cuando un dispositivo se pone OFFLINE
function mostrarNotificacionOffline(deviceId) {
    const audioOffline = new Audio('../assets/images/alerta.mp3'); // 🔊 Sonido para OFFLINE
    audioOffline.play();  

    Swal.fire({
        title: "⚠️ Dispositivo fuera de línea",
        text: `El dispositivo "${deviceId}" se ha desconectado.`,
        icon: "warning",
        confirmButtonText: "Entendido",
        timer: 30000,
        timerProgressBar: true
    });
}

// Notificación cuando un dispositivo vuelve ONLINE
function mostrarNotificacionOnline(deviceId) {
    const audioOnline = new Audio('../assets/images/alertaoffline.mp3'); // 🔊 Sonido para ONLINE
    audioOnline.play();  

    Swal.fire({
        title: "✅ Dispositivo en línea",
        text: `El dispositivo "${deviceId}" se ha reconectado.`,
        icon: "success",
        confirmButtonText: "Entendido",
        timer: 30000,
        timerProgressBar: true
    });
}

// Función para actualizar el marcador en el mapa
function actualizarMarcador(deviceId, lat, lng, status) {
    const nuevoColor = status === "online" ? "green" : "red";

    if (markers[deviceId]) {
        // Si el popup está abierto, lo cerramos antes de actualizar
        if (markers[deviceId].isPopupOpen()) {
            markers[deviceId].closePopup();
        }

        // Actualizar la posición y el color del marcador
        markers[deviceId].setLatLng([lat, lng]);
        markers[deviceId].setStyle({
            fillColor: nuevoColor
        });

        // Actualizar contenido del popup
        markers[deviceId].setPopupContent(`Dispositivo: ${deviceId}<br>Estado: ${status}`);

    } else {
        // Si no existe el marcador, crearlo
        markers[deviceId] = L.circleMarker([lat, lng], {
            radius: 8,
            fillColor: nuevoColor,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);

        // Asignar popup con la información actualizada
        markers[deviceId].bindPopup(`Dispositivo: ${deviceId}<br>Estado: ${status}`);
    }
}

// Función para actualizar los contadores de dispositivos en línea y fuera de línea
function actualizarContadores() {
    const online = Object.values(markers).filter(m => m.options.fillColor === "green").length;
    const offline = totalDispositivos - online;

    document.getElementById("online-count").textContent = online;
    document.getElementById("offline-count").textContent = offline;

    // Obtener la lista de dispositivos offline
    const dispositivosOffline = dispositivos.filter(deviceId => {
        const marker = markers[deviceId];
        return marker && marker.options.fillColor === "red";
    });

    // Guardar la lista de dispositivos offline en localStorage
    localStorage.setItem('dispositivosOffline', JSON.stringify(dispositivosOffline));
}

// Pedir permiso para notificaciones al cargar la página
document.addEventListener("DOMContentLoaded", () => {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});

// Intervalo para actualizar el estado de los dispositivos cada 5 segundos
setInterval(() => {
    dispositivos.forEach(obtenerEstadoDispositivo);
}, 5000);

</script>

  </script>
  <script src="../libs/jquery/jquery/dist/jquery.js"></script>
  <script src="../libs/jquery/tether/dist/js/tether.min.js"></script>
  <script src="../libs/jquery/bootstrap/dist/js/bootstrap.js"></script>
  <script src="../libs/jquery/underscore/underscore-min.js"></script>
  <script src="../libs/jquery/jQuery-Storage-API/jquery.storageapi.min.js"></script>
  <script src="../libs/jquery/PACE/pace.min.js"></script>
  <script src="scripts/config.lazyload.js"></script>
  <script src="scripts/palette.js"></script>
  <script src="scripts/ui-load.js"></script>
  <script src="scripts/ui-jp.js"></script>
  <script src="scripts/ui-include.js"></script>
  <script src="scripts/ui-device.js"></script>
  <script src="scripts/ui-form.js"></script>
  <script src="scripts/ui-nav.js"></script>
  <script src="scripts/ui-screenfull.js"></script>
  <script src="scripts/ui-scroll-to.js"></script>
  <script src="scripts/ui-toggle-class.js"></script>
  <script src="scripts/app.js"></script>
  <script src="../libs/jquery/jquery-pjax/jquery.pjax.js"></script>
  <script src="scripts/ajax.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
